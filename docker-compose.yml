services:
  pinger:
    build: .
    image: pinger:latest
    container_name: pinger
    environment:
      - ENABLE_METRICS=true
      - METRICS_ADDR=0.0.0.0
      - METRICS_PORT=8000
      - ENABLE_HEALTH_ENDPOINT=true
      # Health endpoint security:
      # - Default: 127.0.0.1 (localhost-only) - secure, no auth needed
      # - For Kubernetes/internal network: HEALTH_ADDR=0.0.0.0 + authentication REQUIRED
      - HEALTH_ADDR=0.0.0.0  # Pod network access
      # Authentication (choose ONE method):
      # Method 1: Basic Auth
      # - HEALTH_AUTH_USER=admin
      # - HEALTH_AUTH_PASS=${HEALTH_AUTH_PASS}
      # Method 2: Token Auth (recommended for load balancers/Prometheus)
      # - HEALTH_TOKEN=${HEALTH_TOKEN}
      # For testing only (logs warning):
      # - HEALTH_ALLOW_NO_AUTH=1
      - HEALTH_PORT=8001
      - LOG_TRUNCATE_ON_START=true
    ports:
      - "8000:8000"  # Prometheus metrics
      - "8001:8001"  # Health endpoint
    volumes:
      - ./logs:/app/logs
      - ./traceroutes:/app/traceroutes
    restart: unless-stopped
    # Security: Health endpoint not exposed to host by default (use 127.0.0.1 binding)

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    restart: unless-stopped
